require('../../../app.js');
"use strict";const e=require("../../../common/vendor.js"),t="UNI_ADMIN_UPGRADE_CENTER_LOCAL_FILE_PATH";let i,o=null;const n={data:()=>({installForBeforeFilePath:"",installed:!1,installing:!1,downloadSuccess:!1,downloading:!1,downLoadPercent:0,downloadedSize:0,packageFileSize:0,tempFilePath:"",title:"更新日志",contents:"",is_mandatory:!1,subTitle:"发现新版本",downLoadBtnTextiOS:"立即跳转更新",downLoadBtnText:"立即下载更新",downLoadingText:"安装包下载中，请稍后"}),onLoad({local_storage_key:t}){if(!t)return console.error("local_storage_key为空，请检查后重试"),void e.index.navigateBack();const i=e.index.getStorageSync(t);if(!i)return console.error("安装包信息为空，请检查后重试"),void e.index.navigateBack();const o=["version","url","type"];for(let n in i)if(-1!==o.indexOf(n)&&!i[n])return console.error(`参数 ${n} 必填，请检查后重试`),void e.index.navigateBack();Object.assign(this,i),this.checkLocalStoragePackage()},onBackPress(){if(this.is_mandatory)return!0;this.needNotificationProgress||o&&o.abort()},onHide(){i=null},computed:{isWGT(){return"wgt"===this.type},isiOS(){return!this.isWGT&&-1!==this.platform.indexOf("iOS")},isAndroid(){return-1!==this.platform.indexOf("Android")},isAppStore(){return this.isiOS||!this.isiOS&&!this.isWGT&&-1===this.url.indexOf(".apk")},needNotificationProgress(){return-1===this.platform.indexOf("iOS")&&!this.is_mandatory}},methods:{checkLocalStoragePackage(){const i=e.index.getStorageSync(t);if(i){const{version:e,savedFilePath:t,installed:o}=i;o||0!==function(e="0",t="0"){e=String(e).split("."),t=String(t).split(".");const i=Math.min(e.length,t.length);let o=0;for(let n=0;n<i;n++){const i=Number(e[n]),s=Number(t[n]);if(i>s){o=1;break}if(i<s){o=-1;break}}if(0===o&&e.length!==t.length){const n=e.length>t.length,s=n?e:t;for(let e=i;e<s.length;e++)if(Number(s[e])>0){o=n?1:-1;break}}return o}(e,this.version)?this.deleteSavedFile(t):(this.downloadSuccess=!0,this.installForBeforeFilePath=t,this.tempFilePath=t)}},askAbortDownload(){e.index.showModal({title:"是否取消下载？",cancelText:"否",confirmText:"是",success:t=>{t.confirm&&(o&&o.abort(),cancelNotificationProgress(),e.index.navigateBack())}})},async closeUpdate(){if(this.downloading){if(this.is_mandatory)return e.index.showToast({title:"下载中，请稍后……",icon:"none",duration:500});if(!this.needNotificationProgress)return void this.askAbortDownload()}!this.needNotificationProgress&&this.downloadSuccess&&this.tempFilePath&&await this.saveFile(this.tempFilePath,this.version),e.index.navigateBack()},updateApp(){this.checkStoreScheme().catch((()=>{this.downloadPackage()})).finally((()=>{i=null}))},checkStoreScheme(){const e=(this.store_list||[]).filter((e=>e.enable));return e&&e.length?(e.sort(((e,t)=>t.priority-e.priority)).map((e=>e.scheme)).reduce(((e,t,o)=>(i=(e||(e=Promise.reject())).catch((()=>new Promise(((e,i)=>{plus.runtime.openURL(t,(e=>{i(e)}))})))),i)),i),i):Promise.reject()},downloadPackage(){this.downloading=!0,o=e.index.downloadFile({url:this.url,success:e=>{if(200==e.statusCode)if(this.isWGT&&"wgt"!==e.tempFilePath.split(".").slice(-1)[0]){const t=e=>{console.log("[FILE RENAME FAIL]：",JSON.stringify(e))};plus.io.resolveLocalFileSystemURL(e.tempFilePath,(e=>{e.getParent((i=>{const o=`new_wgt_${Date.now()}.wgt`;e.copyTo(i,o,(e=>{this.tempFilePath=e.fullPath,this.downLoadComplete()}),t)}),t)}),t)}else this.tempFilePath=e.tempFilePath,this.downLoadComplete()}}),o.onProgressUpdate((e=>{this.downLoadPercent=e.progress,this.downloadedSize=(e.totalBytesWritten/Math.pow(1024,2)).toFixed(2),this.packageFileSize=(e.totalBytesExpectedToWrite/Math.pow(1024,2)).toFixed(2),this.needNotificationProgress&&!this.downloadSuccess&&createNotificationProgress({title:"升级中心正在下载安装包……",content:`${this.downLoadPercent}%`,progress:this.downLoadPercent,onClick:()=>{this.askAbortDownload()}})})),this.needNotificationProgress&&e.index.navigateBack()},downLoadComplete(){if(this.downloadSuccess=!0,this.downloading=!1,this.downLoadPercent=0,this.downloadedSize=0,this.packageFileSize=0,o=null,this.needNotificationProgress)return finishNotificationProgress({title:"安装升级包",content:"下载完成"}),void this.installPackage();this.is_mandatory&&this.installPackage()},installPackage(){},restart(){this.installed=!1},saveFile:(i,o)=>new Promise(((n,s)=>{e.index.saveFile({tempFilePath:i,success({savedFilePath:i}){e.index.setStorageSync(t,{version:o,savedFilePath:i})},complete(){n()}})})),deleteSavedFile:i=>(e.index.removeStorageSync(t),e.index.removeSavedFile({filePath:i})),jumpToAppStore(){plus.runtime.openURL(this.url)}}};const s=e._export_sfc(n,[["render",function(t,i,o,n,s,a){return e.e({a:e.t(s.title),b:e.t(s.subTitle),c:e.t(t.version),d:e.t(s.contents),e:a.isAppStore},a.isAppStore?{f:e.t(s.downLoadBtnTextiOS),g:e.o(((...e)=>a.jumpToAppStore&&a.jumpToAppStore(...e)))}:e.e({h:!s.downloadSuccess},s.downloadSuccess?s.downloadSuccess&&!s.installed?{q:e.t(s.installing?"正在安装……":"下载完成，立即安装"),r:s.installing,s:s.installing,t:e.o(((...e)=>a.installPackage&&a.installPackage(...e)))}:s.installed&&!a.isWGT?{w:s.installing,x:s.installing,y:e.o(((...e)=>a.installPackage&&a.installPackage(...e)))}:s.installed&&a.isWGT?{A:e.o(((...e)=>a.restart&&a.restart(...e)))}:{}:e.e({i:s.downloading},s.downloading?{j:s.downLoadPercent,k:e.t(s.downLoadingText),l:e.t(s.downloadedSize),m:e.t(s.packageFileSize)}:{n:e.t(s.downLoadBtnText),o:e.o(((...e)=>a.updateApp&&a.updateApp(...e)))}),{p:s.downloadSuccess&&!s.installed,v:s.installed&&!a.isWGT,z:s.installed&&a.isWGT}),{B:!s.is_mandatory},s.is_mandatory?{}:{C:e.o(((...e)=>a.closeUpdate&&a.closeUpdate(...e)))})}]]);wx.createPage(s);
