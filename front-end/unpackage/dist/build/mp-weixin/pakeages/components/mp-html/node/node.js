"use strict";const t=require("../../../common/vendor.js"),s=require("../parser.js"),e={};function i(t){let s;return s=t.detail.y,(s-t.currentTarget.offsetTop<150||s<600)&&(s=t.currentTarget.offsetTop),s<30&&(s+=70),s-30}const o={name:"node",options:{virtualHost:!0},data:()=>({ctrl:{},isiOS:t.index.getSystemInfoSync().system.includes("iOS")}),props:{name:String,attrs:{type:Object,default:()=>({})},childs:Array,opts:Array},components:{node:()=>Promise.resolve().then((()=>a))},mounted(){this.$nextTick((()=>{for(this.root=this.$parent;"mp-html"!==this.root.$options.name;this.root=this.root.$parent);}))},beforeDestroy(){this.root&&this.root._edit===this&&(this.root._edit=void 0)},methods:{editStart(t){if(this.opts[5]){const s=t.currentTarget.dataset.i;this.ctrl["e"+s]?(this.root._mask.pop(),this.root._maskTap(),this.$set(this.ctrl,"e"+s,2),setTimeout((()=>{this.$set(this.ctrl,"e"+s,3)}),50)):(this.$set(this.ctrl,"e"+s,1),setTimeout((()=>{this.root._mask.push((()=>this.$set(this.ctrl,"e"+s,0)))}),50),this.root._edit=this,this.i=s,this.cursor=this.childs[s].text.length)}},editInput(t){const s=t.target.dataset.i,e=t.detail.value.replace(/ {2,}/,(t=>{let s=" ";for(let e=1;e<t.length;e++)s+=" ";return s}));this.root._editVal(`${this.opts[7]}.${s}.text`,this.childs[s].text,e),this.cursor=t.detail.cursor},editEnd(t){const s=t.target.dataset.i;this.$set(this.ctrl,"e"+s,0),this.root._setData(`${this.opts[7]}.${s}.text`,t.detail.value.replace(/ {2}/g,"  ")),void 0!==t.detail.cursor&&(this.cursor=t.detail.cursor)},insert(t){setTimeout((()=>{const s=this.childs.slice(0);if(s[this.i])if(s[this.i].text){const e=s[this.i].text;if("text"===t.type)this.cursor?s[this.i].text=e.substring(0,this.cursor)+t.text+e.substring(this.cursor):s[this.i].text+=t.text;else{const i=[];this.cursor&&i.push({type:"text",text:e.substring(0,this.cursor)}),i.push(t),this.cursor<e.length&&i.push({type:"text",text:e.substring(this.cursor)}),s.splice(this.i,1,...i)}}else s.splice(parseInt(this.i)+1,0,t);else s.push(t);this.root._editVal(this.opts[7],this.childs,s,!0),this.i=parseInt(this.i)+1}),200)},remove(t){const s=this.childs.slice(0),e=s.splice(t,1)[0];if("img"===e.name||"video"===e.name||"audio"===e.name){let t=e.attrs.src;e.src&&(t=1===e.src.length?e.src[0]:e.src),this.root.$emit("remove",{type:e.name,src:t})}this.root._edit=void 0,this.root._maskTap(),this.root._editVal(this.opts[7],this.childs,s,!0)},nodeTap(t){if(this.opts[5]){if(this.root._lock)return;if(this.root._lock=!0,setTimeout((()=>{this.root._lock=!1}),50),3===this.ctrl["e"+this.i])return;this.root._maskTap(),this.root._edit=this;let s=this.opts[7].lastIndexOf("children.");-1!==s?s+=9:s=6;const e=parseInt(this.opts[7].substring(s,this.opts[7].lastIndexOf(".children")));let o=this.$parent;for(;o&&"node"!==o.$options.name;)o=o.$parent;if(!o||this.opts[7].length-o.opts[7].length>15)return;this.$set(this.ctrl,"root",1),this.root._mask.push((()=>this.$set(this.ctrl,"root",0))),1!==this.childs.length||"text"!==this.childs[0].type||this.ctrl.e0||(this.$set(this.ctrl,"e0",1),this.root._mask.push((()=>this.$set(this.ctrl,"e0",0))),this.i=0,this.cursor=this.childs[0].text.length);const r=this.root._getItem(o.childs[e],0!==e,e!==o.childs.length-1);this.root._tooltip({top:i(t),items:r,success:s=>{if("大小"===r[s]){const s=o.childs[e].attrs.style||"";let r=s.match(/;font-size:([0-9]+)px/);r=r?parseInt(r[1]):16,this.root._slider({min:10,max:30,value:r,top:i(t),changing:s=>{Math.abs(s-r)>2&&(o.changeStyle("font-size",e,s+"px",r+"px"),r=t.detail.value)},change:t=>{t!==r&&o.changeStyle("font-size",e,t+"px",r+"px"),this.root._editVal(`${o.opts[7]}.${e}.attrs.style`,s,o.childs[e].attrs.style)}})}else if("颜色"===r[s]){const s=this.root._getItem("color");this.root._color({top:i(t),items:s,success:t=>{const i=o.childs[e].attrs.style||"",r=i.match(/;color:([^;]+)/);o.changeStyle("color",e,s[t],r?r[1]:void 0),this.root._editVal(`${o.opts[7]}.${e}.attrs.style`,i,o.childs[e].attrs.style)}})}else if("上移"===r[s]||"下移"===r[s]){const t=o.childs.slice(0),i=t[e];"上移"===r[s]?(t[e]=t[e-1],t[e-1]=i):(t[e]=t[e+1],t[e+1]=i),this.root._editVal(o.opts[7],o.childs,t,!0)}else if("删除"===r[s])o.remove(e);else{const t=o.childs[e].attrs.style||"";let i="";const a=r[s];let h,l;"斜体"===a?(h="font-style",l="italic"):"粗体"===a?(h="font-weight",l="bold"):"下划线"===a?(h="text-decoration",l="underline"):"居中"===a?(h="text-align",l="center"):"缩进"===a&&(h="text-indent",l="2em"),i=t.includes(h+":")?t.replace(new RegExp(h+":[^;]+"),""):t+";"+h+":"+l,this.root._editVal(`${o.opts[7]}.${e}.attrs.style`,t,i,!0)}}})}},mediaTap(s,e){if(this.opts[5]){const i=s.target.dataset.i||e,o=this.childs[i],r=this.root._getItem(o);this.root._maskTap(),this.root._edit=this,this.i=i,this.root._tooltip({top:s.currentTarget.offsetTop-30,items:r,success:s=>{switch(r[s]){case"封面":this.root.getSrc("img",o.attrs.poster||"").then((t=>{this.root._editVal(`${this.opts[7]}.${i}.attrs.poster`,o.attrs.poster,t instanceof Array?t[0]:t,!0)})).catch((()=>{}));break;case"删除":this.remove(i);break;case"循环":case"不循环":this.root._setData(`${this.opts[7]}.${i}.attrs.loop`,!o.attrs.loop),t.index.showToast({title:"成功"});break;case"自动播放":case"不自动播放":this.root._setData(`${this.opts[7]}.${i}.attrs.autoplay`,!o.attrs.autoplay),t.index.showToast({title:"成功"})}}}),this.root._lock=!0,setTimeout((()=>{this.root._lock=!1}),50)}},changeStyle(t,s,e,i){let o=this.childs[s].attrs.style||"";o.includes(";"+t+":"+i)?o=o.replace(";"+t+":"+i,";"+t+":"+e):o+=";"+t+":"+e,this.root._setData(`${this.opts[7]}.${s}.attrs.style`,o)},toJSON(){return this},play(s){if(this.root.$emit("play"),this.root.pauseVideo){let e=!1;const i=s.target.id;for(let t=this.root._videos.length;t--;)this.root._videos[t].id===i?e=!0:this.root._videos[t].pause();if(!e){const s=t.index.createVideoContext(i,this);s.id=i,this.root.playbackRate&&s.playbackRate(this.root.playbackRate),this.root._videos.push(s)}}},imgTap(e){if(this.opts[5]){const o=e.currentTarget.dataset.i,r=this.childs[o],a=this.root._getItem(r),h=new s.Parser(this.root);this.root._edit=this,this.i=o,this.root._maskTap(),this.$set(this.ctrl,"e"+o,1),this.root._mask.push((()=>this.$set(this.ctrl,"e"+o,0))),this.root._tooltip({top:i(e),items:a,success:s=>{if("换图"===a[s])this.root.getSrc("img",r.attrs.src||"").then((t=>{this.root._editVal(this.opts[7]+"."+o+".attrs.src",r.attrs.src,h.getUrl(t instanceof Array?t[0]:t),!0)})).catch((()=>{}));else if("宽度"===a[s]){const t=r.attrs.style||"";let s=t.match(/max-width:([0-9]+)%/);s=s?parseInt(s[1]):100,this.root._slider({min:0,max:100,value:s,top:i(e),changing:t=>{Math.abs(t-s)>5&&(this.changeStyle("max-width",o,t+"%",s+"%"),s=t)},change:e=>{e!==s&&(this.changeStyle("max-width",o,e+"%",s+"%"),s=e),this.root._editVal(this.opts[7]+"."+o+".attrs.style",t,this.childs[o].attrs.style)}})}else"超链接"===a[s]?this.root.getSrc("link",r.a?r.a.href:"").then((s=>{if(r.a)this.root._editVal(this.opts[7]+"."+o+".a.href",r.a.href,h.getUrl(s),!0);else{const t={name:"a",attrs:{href:h.getUrl(s)},children:[r]};r.a=t.attrs,this.root._editVal(this.opts[7]+"."+o,r,t,!0)}t.wx$1.showToast({title:"成功"})})).catch((()=>{})):"预览图"===a[s]?this.root.getSrc("img",r.attrs["original-src"]||"").then((s=>{this.root._editVal(this.opts[7]+"."+o+".attrs.original-src",r.attrs["original-src"],h.getUrl(s instanceof Array?s[0]:s),!0),t.index.showToast({title:"成功"})})).catch((()=>{})):"删除"===a[s]?this.remove(o):(this.root._setData(this.opts[7]+"."+o+".attrs.ignore",!r.attrs.ignore),t.index.showToast({title:"成功"}))}}),this.root._lock=!0,setTimeout((()=>{this.root._lock=!1}),50)}else{const s=this.childs[e.currentTarget.dataset.i];if(s.a)return void this.linkTap(s.a);if(s.attrs.ignore)return;this.root.$emit("imgtap",s.attrs),this.root.previewImg&&t.index.previewImage({showmenu:this.root.showImgMenu,current:parseInt(s.attrs.i),urls:this.root.imgList})}},imgLongTap(t){},imgLoad(s){this.opts[5]&&this.$nextTick((()=>{const s=this.childs[e].attrs.id||"n"+e;t.index.createSelectorQuery().in(this).select("#"+s).boundingClientRect().exec((t=>{this.$set(this.ctrl,"h"+e,t[0].height)}))}));const e=s.currentTarget.dataset.i;if(this.childs[e].w)(this.opts[1]&&!this.ctrl[e]||-1===this.ctrl[e])&&this.$set(this.ctrl,e,1);else if(this.$set(this.ctrl,e,s.detail.width),this.opts[5]){const t=this.opts[7]+"."+e+".attrs.";s.detail.width<150&&this.root._setData(t+"ignore","T"),this.root._setData(t+"width",s.detail.width.toString())}this.checkReady()},checkReady(){this.root&&!this.root.lazyLoad&&(this.root._unloadimgs-=1,this.root._unloadimgs||setTimeout((()=>{this.root.getRect().then((t=>{this.root.$emit("ready",t)})).catch((()=>{this.root.$emit("ready",{})}))}),350))},linkTap(s){if(this.opts[5]){const e=s.currentTarget.dataset.i,o=this.childs[e],r=this.root._getItem(o);this.root._tooltip({top:i(s),items:r,success:s=>{"更换链接"===r[s]?this.root.getSrc("link",o.attrs.href).then((s=>{this.root._editVal(this.opts[7]+"."+e+".attrs.href",o.attrs.href,s,!0),t.index.showToast({title:"成功"})})).catch((()=>{})):this.remove(e)}})}else{const e=s.currentTarget?this.childs[s.currentTarget.dataset.i]:{},i=e.attrs||s,o=i.href;this.root.$emit("linktap",Object.assign({innerText:this.root.getText(e.children||[])},i)),o&&("#"===o[0]?this.root.navigateTo(o.substring(1)).catch((()=>{})):o.split("?")[0].includes("://")?this.root.copyLink&&t.index.setClipboardData({data:o,success:()=>t.index.showToast({title:"链接已复制"})}):t.index.navigateTo({url:o,fail(){t.index.switchTab({url:o,fail(){}})}}))}},mediaError(t){const s=t.currentTarget.dataset.i,e=this.childs[s];if("video"===e.name||"audio"===e.name){let t=(this.ctrl[s]||0)+1;if(t>e.src.length&&(t=0),t<e.src.length)return void this.$set(this.ctrl,s,t)}else"img"===e.name&&(this.opts[2]&&this.$set(this.ctrl,s,-1),this.checkReady());this.root&&this.root.$emit("error",{source:e.name,attrs:e.attrs,errMsg:t.detail.errMsg})}}};if(!Array){t.resolveComponent("node")()}"function"==typeof e&&e(o);const r=t._export_sfc(o,[["render",function(s,e,i,o,r,a){return{a:t.f(i.childs,((s,e,o)=>t.e({a:"img"===s.name&&!s.t&&(i.opts[1]&&!r.ctrl[e]||r.ctrl[e]<0)},"img"===s.name&&!s.t&&(i.opts[1]&&!r.ctrl[e]||r.ctrl[e]<0)?{b:t.s(s.attrs.style),c:r.ctrl[e]<0?i.opts[2]:i.opts[1]}:{},{d:"img"===s.name&&s.t},"img"===s.name&&s.t?{e:t.s("display:"+s.t),f:[{attrs:{style:s.attrs.style||"",src:s.attrs.src},name:"img"}],g:e,h:t.o(((...t)=>a.imgTap&&a.imgTap(...t)),e)}:"img"===s.name?{j:s.attrs.id||"n"+e,k:t.n("_img "+s.attrs.class),l:t.s((r.ctrl["e"+e]?"border:1px dashed black;padding:3px;":"")+(-1===r.ctrl[e]?"display:none;":"")+"width:"+(r.ctrl[e]||1)+"px;height:"+(r.ctrl["h"+e]||1)+"px;"+s.attrs.style),m:s.attrs.src,n:s.h?s.w?s.m||"scaleToFill":"heightFix":"widthFix",o:i.opts[0],p:s.webp,q:!i.opts[5]&&i.opts[3]&&!s.attrs.ignore,r:i.opts[5]||!i.opts[3]||s.attrs.ignore,s:e,t:t.o(((...t)=>a.imgLoad&&a.imgLoad(...t)),e),v:t.o(((...t)=>a.mediaError&&a.mediaError(...t)),e),w:t.o(((...t)=>a.imgTap&&a.imgTap(...t)),e),x:t.o(((...t)=>a.imgLongTap&&a.imgLongTap(...t)),e)}:"text"!==s.type||r.ctrl["e"+e]?"text"===s.type&&1===r.ctrl["e"+e]?t.e({H:t.t(s.text),I:!s.text},s.text?{}:{J:t.t(i.opts[6]||"请输入")},{K:e,L:t.o(((...t)=>a.editStart&&a.editStart(...t)),e)}):"text"===s.type?{N:3===r.ctrl["e"+e],O:s.text,P:e,Q:t.o(((...t)=>a.editInput&&a.editInput(...t)),e),R:t.o(((...t)=>a.editEnd&&a.editEnd(...t)),e)}:"br"===s.name?{}:"a"===s.name?{U:"943cdbbe-0-"+o,V:t.p({name:"span",childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children"]}),W:s.attrs.id,X:t.n((s.attrs.href?"_a ":"")+s.attrs.class),Y:t.s("display:inline;"+s.attrs.style),Z:e,aa:t.o(((...t)=>a.linkTap&&a.linkTap(...t)),e)}:"video"===s.name?{ac:!i.opts[5],ad:t.o(((...t)=>a.mediaTap&&a.mediaTap(...t)),e),ae:s.attrs.id,af:t.n(s.attrs.class),ag:t.s(s.attrs.style),ah:s.attrs.autoplay,ai:s.attrs.controls,aj:s.attrs.loop,ak:s.attrs.muted,al:s.attrs["object-fit"],am:s.attrs.poster,an:s.src[r.ctrl[e]||0],ao:e,ap:t.o(((...t)=>a.play&&a.play(...t)),e),aq:t.o(((...t)=>a.mediaError&&a.mediaError(...t)),e)}:"audio"===s.name?{as:t.o(((...t)=>a.mediaTap&&a.mediaTap(...t)),e),at:s.attrs.id,av:t.n(s.attrs.class),aw:t.s(s.attrs.style),ax:s.attrs.author,ay:s.attrs.controls,az:s.attrs.loop,aA:s.attrs.name,aB:s.attrs.poster,aC:s.src[r.ctrl[e]||0],aD:e,aE:t.o(((...t)=>a.play&&a.play(...t)),e),aF:t.o(((...t)=>a.mediaError&&a.mediaError(...t)),e)}:"table"===s.name&&(s.c||i.opts[5])||"li"===s.name?t.e({aH:"li"===s.name},"li"===s.name?{aI:"943cdbbe-1-"+o,aJ:t.p({childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children"]})}:{aK:t.f(s.children,((s,r,a)=>t.e({a:"td"===s.name||"th"===s.name},"td"===s.name||"th"===s.name?{b:"943cdbbe-2-"+o+"-"+a,c:t.p({childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children."+r+".children"]})}:{d:t.f(s.children,((s,h,l)=>t.e({a:"td"===s.name||"th"===s.name},"td"===s.name||"th"===s.name?{b:"943cdbbe-3-"+o+"-"+a+"-"+l,c:t.p({childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children."+r+".children."+h+".children"]}),d:t.n("_"+s.name+" "+s.attrs.class),e:t.s(s.attrs.style)}:{f:t.f(s.children,((s,c,n)=>({a:"943cdbbe-4-"+o+"-"+a+"-"+l+"-"+n,b:t.p({childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children."+r+".children."+h+".children."+c+".children"]}),c:c,d:t.n("_"+s.name+" "+s.attrs.class),e:t.s(s.attrs.style)}))),g:t.n("_"+s.name+" "+s.attrs.class),h:t.s(s.attrs.style)},{i:h})))},{e:r,f:t.n("_"+s.name+" "+s.attrs.class),g:t.s(s.attrs.style)})))},{aL:s.attrs.id,aM:t.n("_"+s.name+" "+s.attrs.class),aN:t.s(s.attrs.style)}):i.opts[5]||s.c?2===s.c?{aV:t.f(s.children,((s,r,a)=>({a:r,b:t.s(s.f),c:"943cdbbe-5-"+o+"-"+a,d:t.p({name:s.name,attrs:s.attrs,childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children."+r+".children"]})}))),aW:s.attrs.id,aX:t.n("_block _"+s.name+" "+s.attrs.class),aY:t.s(s.f+";"+s.attrs.style)}:{aZ:t.s(s.f),ba:"943cdbbe-6-"+o,bb:t.p({name:s.name,attrs:s.attrs,childs:s.children,opts:[i.opts[0],i.opts[1],i.opts[2],i.opts[3],i.opts[4],i.opts[5],i.opts[6],i.opts[7]+"."+e+".children"]})}:{aP:s.attrs.id,aQ:t.s("display:inline;"+s.f),aR:i.opts[4],aS:i.opts[4],aT:[s]}:t.e({z:t.t(s.text),A:!s.text},s.text?{}:{B:t.t(i.opts[6]||"请输入")},{C:e,D:i.opts[4],E:!i.opts[5],F:t.o(((...t)=>a.editStart&&a.editStart(...t)),e)}),{i:"img"===s.name,y:"text"===s.type&&!r.ctrl["e"+e],G:"text"===s.type&&1===r.ctrl["e"+e],M:"text"===s.type,S:"br"===s.name,T:"a"===s.name,ab:"video"===s.name,ar:"audio"===s.name,aG:"table"===s.name&&(s.c||i.opts[5])||"li"===s.name,aO:!i.opts[5]&&!s.c,aU:2===s.c,bc:e}))),b:t.o(((...t)=>a.nodeTap&&a.nodeTap(...t))),c:i.attrs.id,d:t.n("_block _"+i.name+" "+i.attrs.class),e:t.s((r.ctrl.root?"border:1px solid black;padding:5px;display:block;":"")+i.attrs.style)}}]]);wx.createComponent(r);const a=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));
