"use strict";const t=require("../../common/vendor.js"),e={trustTags:l("a,abbr,ad,audio,b,blockquote,br,code,col,colgroup,dd,del,dl,dt,div,em,fieldset,h1,h2,h3,h4,h5,h6,hr,i,img,ins,label,legend,li,ol,p,q,ruby,rt,source,span,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,title,ul,video"),blockTags:l("address,article,aside,body,caption,center,cite,footer,header,html,nav,pre,section"),inlineTags:l("abbr,b,big,code,del,em,i,ins,label,q,small,span,strong,sub,sup"),ignoreTags:l("area,base,canvas,embed,frame,head,iframe,input,link,map,meta,param,rp,script,source,style,textarea,title,track,wbr"),voidTags:l("area,base,br,col,circle,ellipse,embed,frame,hr,img,input,line,link,meta,param,path,polygon,rect,source,track,use,wbr"),entities:{lt:"<",gt:">",quot:'"',apos:"'",ensp:" ",emsp:" ",nbsp:" ",semi:";",ndash:"–",mdash:"—",middot:"·",lsquo:"‘",rsquo:"’",ldquo:"“",rdquo:"”",bull:"•",hellip:"…",larr:"←",uarr:"↑",rarr:"→",darr:"↓"},tagStyle:{address:"font-style:italic",big:"display:inline;font-size:1.2em",caption:"display:table-caption;text-align:center",center:"text-align:center",cite:"font-style:italic",dd:"margin-left:40px",mark:"background-color:yellow",pre:"font-family:monospace;white-space:pre",s:"text-decoration:line-through",small:"display:inline;font-size:0.8em",strike:"text-decoration:line-through",u:"text-decoration:underline"},svgDict:{animatetransform:"animateTransform",lineargradient:"linearGradient",viewbox:"viewBox",attributename:"attributeName",repeatcount:"repeatCount",repeatdur:"repeatDur",foreignobject:"foreignObject"}},i={},{windowWidth:s,system:n}=t.index.getSystemInfoSync(),a=l(" ,\r,\n,\t,\f");let r=0;function l(t){const e=Object.create(null),i=t.split(",");for(let s=i.length;s--;)e[i[s]]=!0;return e}function o(t,i){let s=t.indexOf("&");for(;-1!==s;){const n=t.indexOf(";",s+3);let a;if(-1===n)break;"#"===t[s+1]?(a=parseInt(("x"===t[s+2]?"0":"")+t.substring(s+2,n)),isNaN(a)||(t=t.substr(0,s)+String.fromCharCode(a)+t.substr(n+1))):(a=t.substring(s+1,n),(e.entities[a]||"amp"===a&&i)&&(t=t.substr(0,s)+(e.entities[a]||"&")+t.substr(n+1))),s=t.indexOf("&",s+1)}return t}function h(t){let e=t.length-1;for(let i=e;i>=-1;i--)(-1===i||t[i].c||!t[i].name||"div"!==t[i].name&&"p"!==t[i].name&&"h"!==t[i].name[0]||(t[i].attrs.style||"").includes("inline"))&&(e-i>=5&&t.splice(i+1,e-i,{name:"div",attrs:{},children:t.slice(i+1,e+1)}),e=i-1)}function c(t){this.options=t||{},this.tagStyle=Object.assign({},e.tagStyle,this.options.tagStyle),this.imgList=t.imgList||[],this.imgList._unloadimgs=0,this.plugins=t.plugins||[],this.attrs=Object.create(null),this.stack=[],this.nodes=[],this.pre=(this.options.containerStyle||"").includes("white-space")&&this.options.containerStyle.includes("pre")?2:0}function d(t){this.handler=t}c.prototype.parse=function(t){for(let i=this.plugins.length;i--;)this.plugins[i].onUpdate&&(t=this.plugins[i].onUpdate(t,e)||t);for(new d(this).parse(t);this.stack.length;)this.popNode();return this.nodes.length>50&&h(this.nodes),this.nodes},c.prototype.expose=function(){for(let t=this.stack.length;t--;){const e=this.stack[t];if(e.c||"a"===e.name||"video"===e.name||"audio"===e.name)return;e.c=1}},c.prototype.hook=function(t){for(let e=this.plugins.length;e--;)if(this.plugins[e].onParse&&!1===this.plugins[e].onParse(t,this))return!1;return!0},c.prototype.getUrl=function(t){const e=this.options.domain;return"/"===t[0]?"/"===t[1]?t=(e?e.split("://")[0]:"http")+":"+t:e&&(t=e+t):t.includes("data:")||t.includes("://")||e&&(t=e+"/"+t),t},c.prototype.parseStyle=function(t){const e=t.attrs,i=(this.tagStyle[t.name]||"").split(";").concat((e.style||"").split(";")),n={};let r="";e.id&&!this.xml&&(this.options.useAnchor?this.expose():"img"!==t.name&&"a"!==t.name&&"video"!==t.name&&"audio"!==t.name&&(e.id=void 0)),e.width&&(n.width=parseFloat(e.width)+(e.width.includes("%")?"%":"px"),e.width=void 0),e.height&&(n.height=parseFloat(e.height)+(e.height.includes("%")?"%":"px"),e.height=void 0);for(let l=0,o=i.length;l<o;l++){const t=i[l].split(":");if(t.length<2)continue;const e=t.shift().trim().toLowerCase();let o=t.join(":").trim();if("-"===o[0]&&o.lastIndexOf("-")>0||o.includes("safe"))r+=`;${e}:${o}`;else if(!n[e]||o.includes("import")||!n[e].includes("import")){if(o.includes("url")){let t=o.indexOf("(")+1;if(t){for(;'"'===o[t]||"'"===o[t]||a[o[t]];)t++;o=o.substr(0,t)+this.getUrl(o.substr(t))}}else o.includes("rpx")&&(o=o.replace(/[0-9.]+\s*rpx/g,(t=>parseFloat(t)*s/750+"px")));n[e]=o}}return t.attrs.style=r,n},c.prototype.onTagName=function(t){this.tagName=this.xml?t:t.toLowerCase(),"svg"===this.tagName&&(this.xml=(this.xml||0)+1,e.ignoreTags.style=void 0)},c.prototype.onAttrName=function(t){"data-"===(t=this.xml?t:t.toLowerCase()).substr(0,5)?"data-src"!==t||this.attrs.src?"img"===this.tagName||"a"===this.tagName?this.attrName=t:this.attrName=void 0:this.attrName="src":(this.attrName=t,this.attrs[t]="T")},c.prototype.onAttrVal=function(t){const e=this.attrName||"";"style"===e||"href"===e?this.attrs[e]=o(t,!0):e.includes("src")?this.attrs[e]=this.getUrl(o(t,!0)):e&&(this.attrs[e]=t)},c.prototype.onOpenTag=function(t){const n=Object.create(null);n.name=this.tagName,n.attrs=this.attrs,this.options.nodes.length&&(n.type="node"),this.attrs=Object.create(null);const a=n.attrs,l=this.stack[this.stack.length-1],o=l?l.children:this.nodes,h=this.xml?t:e.voidTags[n.name];if(i[n.name]&&(a.class=i[n.name]+(a.class?" "+a.class:"")),"embed"===n.name){const t=a.src||"";t.includes(".mp4")||t.includes(".3gp")||t.includes(".m3u8")||(a.type||"").includes("video")?n.name="video":(t.includes(".mp3")||t.includes(".wav")||t.includes(".aac")||t.includes(".m4a")||(a.type||"").includes("audio"))&&(n.name="audio"),a.autostart&&(a.autoplay="T"),a.controls="T"}if("video"!==n.name&&"audio"!==n.name||("video"!==n.name||a.id||(a.id="v"+r++),a.controls||a.autoplay||(a.controls="T"),n.src=[],a.src&&(n.src.push(a.src),a.src=void 0),this.expose()),h){if(!this.hook(n)||e.ignoreTags[n.name])return void("base"!==n.name||this.options.domain?"source"===n.name&&l&&("video"===l.name||"audio"===l.name)&&a.src&&l.src.push(a.src):this.options.domain=a.href);const t=this.parseStyle(n);if("img"===n.name){if(a.src&&(a.src.includes("webp")&&(n.webp="T"),a.src.includes("data:")&&!a["original-src"]&&(a.ignore="T"),!a.ignore||n.webp||a.src.includes("cloud://"))){for(let i=this.stack.length;i--;){const e=this.stack[i];"a"===e.name&&(n.a=e.attrs),"table"!==e.name||n.webp||a.src.includes("cloud://")||(!t.display||t.display.includes("inline")?n.t="inline-block":n.t=t.display,t.display=void 0);const s=e.attrs.style||"";if(!s.includes("flex:")||s.includes("flex:0")||s.includes("flex: 0")||t.width&&!(parseInt(t.width)>100))if(s.includes("flex")&&"100%"===t.width)for(let n=i+1;n<this.stack.length;n++){const e=this.stack[n].attrs.style||"";if(!e.includes(";width")&&!e.includes(" width")&&0!==e.indexOf("width")){t.width="";break}}else s.includes("inline-block")&&(t.width&&"%"===t.width[t.width.length-1]?(e.attrs.style+=";max-width:"+t.width,t.width=""):e.attrs.style+=";max-width:100%");else{t.width="100% !important",t.height="";for(let t=i+1;t<this.stack.length;t++)this.stack[t].attrs.style=(this.stack[t].attrs.style||"").replace("inline-","")}e.c=1}a.i=this.imgList.length.toString();let e=a["original-src"]||a.src;if(this.imgList.includes(e)){let t=e.indexOf("://");if(-1!==t){t+=3;let i=e.substr(0,t);for(;t<e.length&&"/"!==e[t];t++)i+=Math.random()>.5?e[t].toUpperCase():e[t];i+=e.substr(t),e=i}}this.imgList.push(e),n.t||(this.imgList._unloadimgs+=1)}"inline"===t.display&&(t.display=""),a.ignore&&(t["max-width"]=t["max-width"]||"100%",a.style+=";-webkit-touch-callout:none"),parseInt(t.width)>s&&(t.height=void 0),isNaN(parseInt(t.width))||(n.w="T"),!isNaN(parseInt(t.height))&&(!t.height.includes("%")||l&&(l.attrs.style||"").includes("height"))&&(n.h="T"),n.w&&n.h&&t["object-fit"]&&("contain"===t["object-fit"]?n.m="aspectFit":"cover"===t["object-fit"]&&(n.m="aspectFill"))}else if("svg"===n.name)return o.push(n),this.stack.push(n),void this.popNode();for(const e in t)t[e]&&(a.style+=`;${e}:${t[e].replace(" !important","")}`);a.style=a.style.substr(1)||void 0,a.style||delete a.style}else("pre"===n.name||(a.style||"").includes("white-space")&&a.style.includes("pre"))&&2!==this.pre&&(this.pre=n.pre=1),n.children=[],this.stack.push(n);o.push(n)},c.prototype.onCloseTag=function(t){let e;for(t=this.xml?t:t.toLowerCase(),e=this.stack.length;e--&&this.stack[e].name!==t;);if(-1!==e)for(;this.stack.length>e;)this.popNode();else if("p"===t||"br"===t){(this.stack.length?this.stack[this.stack.length-1].children:this.nodes).push({name:t,attrs:{class:i[t]||"",style:this.tagStyle[t]||""}})}},c.prototype.popNode=function(){const i=this.options.editable,n=this.stack.pop();let a=n.attrs;const r=n.children,l=this.stack[this.stack.length-1],o=l?l.children:this.nodes;if(!this.hook(n)||e.ignoreTags[n.name])return"title"===n.name&&r.length&&"text"===r[0].type&&this.options.setTitle&&t.index.setNavigationBarTitle({title:r[0].text}),void o.pop();if(n.pre&&2!==this.pre){this.pre=n.pre=void 0;for(let t=this.stack.length;t--;)this.stack[t].pre&&(this.pre=1)}const c={};if("svg"===n.name){if(this.xml>1)return void this.xml--;let t="";const i=a.style;return a.style="",a.xmlns="http://www.w3.org/2000/svg",function i(s){if("text"===s.type)return void(t+=s.text);const n=e.svgDict[s.name]||s.name;if("foreignObject"===n)for(const t of s.children||[])if(t.attrs&&!t.attrs.xmlns){t.attrs.xmlns="http://www.w3.org/1999/xhtml";break}t+="<"+n;for(const a in s.attrs){const i=s.attrs[a];i&&(t+=` ${e.svgDict[a]||a}="${i}"`)}if(s.children){t+=">";for(let t=0;t<s.children.length;t++)i(s.children[t]);t+="</"+n+">"}else t+="/>"}(n),n.name="img",n.attrs={src:"data:image/svg+xml;utf8,"+t.replace(/#/g,"%23"),style:i,ignore:"T"},n.children=void 0,this.xml=!1,void(e.ignoreTags.style=!0)}if(a.align&&("table"===n.name?"center"===a.align?c["margin-inline-start"]=c["margin-inline-end"]="auto":c.float=a.align:c["text-align"]=a.align,a.align=void 0),a.dir&&(c.direction=a.dir,a.dir=void 0),"font"===n.name&&(a.color&&(c.color=a.color,a.color=void 0),a.face&&(c["font-family"]=a.face,a.face=void 0),a.size)){let t=parseInt(a.size);isNaN(t)||(t<1?t=1:t>7&&(t=7),c["font-size"]=["x-small","small","medium","large","x-large","xx-large","xxx-large"][t-1]),a.size=void 0}if((a.class||"").includes("align-center")&&(c["text-align"]="center"),Object.assign(c,this.parseStyle(n)),"table"!==n.name&&parseInt(c.width)>s&&(c["max-width"]="100%",c["box-sizing"]="border-box"),e.blockTags[n.name]?i||(n.name="div"):e.trustTags[n.name]||this.xml||(n.name="span"),"a"===n.name||"ad"===n.name)this.expose();else if("video"===n.name)(c.height||"").includes("auto")&&(c.height=void 0);else if("ul"!==n.name&&"ol"!==n.name||!n.c&&!i){if("table"===n.name){let t=parseFloat(a.cellpadding),e=parseFloat(a.cellspacing);const s=parseFloat(a.border),l=c["border-color"],o=c["border-style"];if((n.c||i)&&(isNaN(t)&&(t=2),isNaN(e)&&(e=2)),s&&(a.style+=`;border:${s}px ${o||"solid"} ${l||"gray"}`),n.flag&&(n.c||i)){c.display="grid","collapse"===c["border-collapse"]&&(c["border-collapse"]=void 0,e=0),e?(c["grid-gap"]=e+"px",c.padding=e+"px"):s&&(a.style+=";border-left:0;border-top:0");const h=[],d=[],p=[],g={};!function t(e){for(let i=0;i<e.length;i++)if("tr"===e[i].name)d.push(e[i]);else if("colgroup"===e[i].name){let t=1;for(const s of e[i].children||[])if("col"===s.name){const e=s.attrs.style||"",i=e.indexOf("width")?e.indexOf(";width"):0;if(-1!==i){let s=e.indexOf(";",i+6);-1===s&&(s=e.length),h[t]=e.substring(i?i+7:6,s)}t+=1}}else t(e[i].children||[])}(r);for(let n=1;n<=d.length;n++){let a=1;for(let r=0;r<d[n-1].children.length;r++){const c=d[n-1].children[r];if("td"===c.name||"th"===c.name){for(;g[n+"."+a];)a++;i&&(c.r=n);let r=c.attrs.style||"",d=r.indexOf("width")?r.indexOf(";width"):0;if(-1!==d){let t=r.indexOf(";",d+6);-1===t&&(t=r.length),c.attrs.colspan||(h[a]=r.substring(d?d+7:6,t)),r=r.substr(0,d)+r.substr(t)}if(r+=";display:flex",d=r.indexOf("vertical-align"),-1!==d){const t=r.substr(d+15,10);t.includes("middle")?r+=";align-items:center":t.includes("bottom")&&(r+=";align-items:flex-end")}else r+=";align-items:center";if(d=r.indexOf("text-align"),-1!==d){const t=r.substr(d+11,10);t.includes("center")?r+=";justify-content: center":t.includes("right")&&(r+=";justify-content: right")}if(r=(s?`;border:${s}px ${o||"solid"} ${l||"gray"}`+(e?"":";border-right:0;border-bottom:0"):"")+(t?`;padding:${t}px`:"")+";"+r,c.attrs.colspan&&(r+=`;grid-column-start:${a};grid-column-end:${a+parseInt(c.attrs.colspan)}`,c.attrs.rowspan||(r+=`;grid-row-start:${n};grid-row-end:${n+1}`),a+=parseInt(c.attrs.colspan)-1),c.attrs.rowspan){r+=`;grid-row-start:${n};grid-row-end:${n+parseInt(c.attrs.rowspan)}`,c.attrs.colspan||(r+=`;grid-column-start:${a};grid-column-end:${a+1}`);for(let t=1;t<c.attrs.rowspan;t++)for(let e=0;e<(c.attrs.colspan||1);e++)g[n+t+"."+(a-e)]=1}r&&(c.attrs.style=r),p.push(c),a++}}if(1===n){let t="";for(let e=1;e<a;e++)t+=(h[e]?h[e]:"auto")+" ";c["grid-template-columns"]=t}}n.children=p}else(n.c||i)&&(c.display="table"),isNaN(e)||(c["border-spacing"]=e+"px"),(s||t)&&function e(i){for(let n=0;n<i.length;n++){const a=i[n];"th"===a.name||"td"===a.name?(s&&(a.attrs.style=`border:${s}px ${o||"solid"} ${l||"gray"};${a.attrs.style||""}`),t&&(a.attrs.style=`padding:${t}px;${a.attrs.style||""}`)):a.children&&e(a.children)}}(r);if(this.options.scrollTable&&!(a.style||"").includes("inline")){const t=Object.assign({},n);n.name="div",n.attrs={style:"overflow:auto"},n.children=[t],a=t.attrs}}else if("td"!==n.name&&"th"!==n.name||!a.colspan&&!a.rowspan)if("ruby"===n.name){n.name="span";for(let t=0;t<r.length-1;t++)"text"===r[t].type&&"rt"===r[t+1].name&&(r[t]={name:"div",attrs:{style:"display:inline-block;text-align:center"},children:[{name:"div",attrs:{style:"font-size:50%;"+(r[t+1].attrs.style||"")},children:r[t+1].children},r[t]]},r.splice(t+1,1))}else!i&&n.c&&function t(i){i.c=2;for(let s=i.children.length;s--;){const n=i.children[s];n.name&&(e.inlineTags[n.name]||(n.attrs.style||"").includes("inline")&&n.children)&&!n.c&&t(n),n.c&&"table"!==n.name||(i.c=1)}}(n);else for(let t=this.stack.length;t--;)if("table"===this.stack[t].name){this.stack[t].flag=1;break}}else{const t={a:"lower-alpha",A:"upper-alpha",i:"lower-roman",I:"upper-roman"};t[a.type]&&(a.style+=";list-style-type:"+t[a.type],a.type=void 0);for(let e=r.length;e--;)"li"===r[e].name&&(r[e].c=1)}if((c.display||"").includes("flex")&&!n.c&&!i)for(let t=r.length;t--;){const e=r[t];e.f&&(e.attrs.style=(e.attrs.style||"")+e.f,e.f=void 0)}const d=l&&((l.attrs.style||"").includes("flex")||(l.attrs.style||"").includes("grid"))&&!((n.c||i)&&t.wx$1.getNFCAdapter);d&&(n.f=";max-width:100%"),r.length>=50&&(n.c||i)&&!(c.display||"").includes("flex")&&h(r);for(const t in c)if(c[t]){const e=`;${t}:${c[t].replace(" !important","")}`;d&&(t.includes("flex")&&"flex-direction"!==t||"align-self"===t||t.includes("grid")||"-"===c[t][0]||t.includes("width")&&e.includes("%"))?(n.f+=e,"width"===t&&(a.style+=";width:100%")):a.style+=e}a.style=a.style.substr(1)||void 0;for(const t in a)a[t]||delete a[t]},c.prototype.onText=function(e){if(!this.pre){let t,i="";for(let s=0,n=e.length;s<n;s++)a[e[s]]?(" "!==i[i.length-1]&&(i+=" "),"\n"!==e[s]||t||(t=!0)):i+=e[s];if(" "===i){if(t)return;{const t=this.stack[this.stack.length-1];if(t&&"t"===t.name[0])return}}e=i}const i=Object.create(null);if(i.type="text",i.text=o(e),this.hook(i)){"force"===this.options.selectable&&n.includes("iOS")&&!t.index.canIUse("rich-text.user-select")&&this.expose();(this.stack.length?this.stack[this.stack.length-1].children:this.nodes).push(i)}},d.prototype.parse=function(t){this.content=t||"",this.i=0,this.start=0,this.state=this.text;for(let e=this.content.length;-1!==this.i&&this.i<e;)this.state()},d.prototype.checkClose=function(t){const e="/"===this.content[this.i];return!!(">"===this.content[this.i]||e&&">"===this.content[this.i+1])&&(t&&this.handler[t](this.content.substring(this.start,this.i)),this.i+=e?2:1,this.start=this.i,this.handler.onOpenTag(e),"script"===this.handler.tagName?(this.i=this.content.indexOf("</",this.i),-1!==this.i&&(this.i+=2,this.start=this.i),this.state=this.endTag):this.state=this.text,!0)},d.prototype.text=function(){if(this.i=this.content.indexOf("<",this.i),-1===this.i)return void(this.start<this.content.length&&this.handler.onText(this.content.substring(this.start,this.content.length)));const t=this.content[this.i+1];if(t>="a"&&t<="z"||t>="A"&&t<="Z")this.start!==this.i&&this.handler.onText(this.content.substring(this.start,this.i)),this.start=++this.i,this.state=this.tagName;else if("/"===t||"!"===t||"?"===t){this.start!==this.i&&this.handler.onText(this.content.substring(this.start,this.i));const e=this.content[this.i+2];if("/"===t&&(e>="a"&&e<="z"||e>="A"&&e<="Z"))return this.i+=2,this.start=this.i,void(this.state=this.endTag);let i="--\x3e";"!"===t&&"-"===this.content[this.i+2]&&"-"===this.content[this.i+3]||(i=">"),this.i=this.content.indexOf(i,this.i),-1!==this.i&&(this.i+=i.length,this.start=this.i)}else this.i++},d.prototype.tagName=function(){if(a[this.content[this.i]]){for(this.handler.onTagName(this.content.substring(this.start,this.i));a[this.content[++this.i]];);this.i<this.content.length&&!this.checkClose()&&(this.start=this.i,this.state=this.attrName)}else this.checkClose("onTagName")||this.i++},d.prototype.attrName=function(){let t=this.content[this.i];if(a[t]||"="===t){this.handler.onAttrName(this.content.substring(this.start,this.i));let e="="===t;const i=this.content.length;for(;++this.i<i;)if(t=this.content[this.i],!a[t]){if(this.checkClose())return;if(e)return this.start=this.i,void(this.state=this.attrVal);if("="!==this.content[this.i])return this.start=this.i,void(this.state=this.attrName);e=!0}}else this.checkClose("onAttrName")||this.i++},d.prototype.attrVal=function(){const t=this.content[this.i],e=this.content.length;if('"'===t||"'"===t){if(this.start=++this.i,this.i=this.content.indexOf(t,this.i),-1===this.i)return;this.handler.onAttrVal(this.content.substring(this.start,this.i))}else for(;this.i<e;this.i++){if(a[this.content[this.i]]){this.handler.onAttrVal(this.content.substring(this.start,this.i));break}if(this.checkClose("onAttrVal"))return}for(;a[this.content[++this.i]];);this.i<e&&!this.checkClose()&&(this.start=this.i,this.state=this.attrName)},d.prototype.endTag=function(){const t=this.content[this.i];if(a[t]||">"===t||"/"===t){if(this.handler.onCloseTag(this.content.substring(this.start,this.i)),">"!==t&&(this.i=this.content.indexOf(">",this.i),-1===this.i))return;this.start=++this.i,this.state=this.text}else this.i++},exports.Parser=c;
