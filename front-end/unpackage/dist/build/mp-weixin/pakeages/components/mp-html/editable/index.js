"use strict";const t=require("./config.js"),e=require("../parser.js");function i(i){this.vm=i,this.editHistory=[],this.editI=-1,i._mask=[],i._setData=function(t,e){const s=t.split(".");let n=i;for(let i=0;i<s.length-1;i++)n=n[s[i]];i.$set(n,s.pop(),e)};const s=t=>{setTimeout((()=>{const e=this.editHistory[this.editI+t];e&&(this.editI+=t,i._setData(e.key,e.value))}),200)};function n(t){if(i._edit)i._edit.insert(t);else{const e=i.nodes.slice(0);e.push(t),i._editVal("nodes",i.nodes,e,!0)}}function r(t){"string"==typeof t.src&&(t.src=[t.src]);const s=new e.Parser(i);for(let e=0;e<t.src.length;e++)t.src[e]=s.getUrl(t.src[e]);n({name:"div",attrs:{style:"text-align:center"},children:[t]})}i.undo=()=>s(-1),i.redo=()=>s(1),i._editVal=(t,e,s,n)=>{for(;this.editI<this.editHistory.length-1;)this.editHistory.pop();for(;this.editHistory.length>30;)this.editHistory.pop(),this.editI--;const r=this.editHistory[this.editHistory.length-1];r&&r.key===t||(r&&(this.editHistory.pop(),this.editI--),this.editHistory.push({key:t,value:e}),this.editI++),this.editHistory.push({key:t,value:s}),this.editI++,n&&i._setData(t,s)},i._getItem=function(e,s,n){let r,l;return"color"===e?t.config.color:("img"===e.name?(r=t.config.img.slice(0),i.getSrc||(l=r.indexOf("换图"),-1!==l&&r.splice(l,1),l=r.indexOf("超链接"),-1!==l&&r.splice(l,1),l=r.indexOf("预览图"),-1!==l&&r.splice(l,1)),l=r.indexOf("禁用预览"),-1!==l&&e.attrs.ignore&&(r[l]="启用预览")):"a"===e.name?(r=t.config.link.slice(0),i.getSrc||(l=r.indexOf("更换链接"),-1!==l&&r.splice(l,1))):"video"===e.name||"audio"===e.name?(r=t.config.media.slice(0),l=r.indexOf("封面"),i.getSrc||-1===l||r.splice(l,1),l=r.indexOf("循环"),e.attrs.loop&&-1!==l&&(r[l]="不循环"),l=r.indexOf("自动播放"),e.attrs.autoplay&&-1!==l&&(r[l]="不自动播放")):r="card"===e.name?t.config.card.slice(0):t.config.node.slice(0),s||(l=r.indexOf("上移"),-1!==l&&r.splice(l,1)),n||(l=r.indexOf("下移"),-1!==l&&r.splice(l,1)),r)},i._tooltip=function(t){i.$set(i,"tooltip",{top:t.top,items:t.items}),i._tooltipcb=t.success},i._slider=function(t){i.$set(i,"slider",{min:t.min,max:t.max,value:t.value,top:t.top}),i._slideringcb=t.changing,i._slidercb=t.change},i._color=function(t){i.$set(i,"color",{items:t.items,top:t.top}),i._colorcb=t.success},i._maskTap=function(){for(;i._mask.length;)i._mask.pop()();i.tooltip&&i.$set(i,"tooltip",null),i.slider&&i.$set(i,"slider",null),i.color&&i.$set(i,"color",null)},i.insertHtml=t=>{this.inserting=!0;const s=new e.Parser(i).parse(t);this.inserting=void 0;for(let e=0;e<s.length;e++)n(s[e])},i.insertImg=function(){i.getSrc&&i.getSrc("img").then((t=>{"string"==typeof t&&(t=[t]);const s=new e.Parser(i);for(let e=0;e<t.length;e++)n({name:"img",attrs:{src:s.getUrl(t[e])}})})).catch((()=>{}))},i.insertLink=function(){i.getSrc&&i.getSrc("link").then((t=>{n({name:"a",attrs:{href:t},children:[{type:"text",text:t}]})})).catch((()=>{}))},i.insertTable=function(t,e){const i={name:"table",attrs:{style:"display:table;width:100%;margin:10px 0;text-align:center;border-spacing:0;border-collapse:collapse;border:1px solid gray"},children:[]};for(let s=0;s<t;s++){const t={name:"tr",attrs:{},children:[]};for(let i=0;i<e;i++)t.children.push({name:"td",attrs:{style:"padding:2px;border:1px solid gray"},children:[{type:"text",text:""}]});i.children.push(t)}n(i)},i.insertVideo=function(){i.getSrc&&i.getSrc("video").then((t=>{r({name:"video",attrs:{controls:"T"},children:[],src:t})})).catch((()=>{}))},i.insertAudio=function(){i.getSrc&&i.getSrc("audio").then((t=>{let e;t.src?(e=t.src,t.src=void 0):(e=t,t={}),t.controls="T",r({name:"audio",attrs:t,children:[],src:e})})).catch((()=>{}))},i.insertText=function(){n({name:"p",attrs:{},children:[{type:"text",text:""}]})},i.clear=function(){i._maskTap(),i._edit=void 0,i.$set(i,"nodes",[{name:"p",attrs:{},children:[{type:"text",text:""}]}])},i.getContent=function(){let t="";!function e(i,s){for(let n=0;n<i.length;n++){let r=i[n];if("text"===r.type)t+=r.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/\xa0/g,"&nbsp;");else{if("img"===r.name){if(r.attrs.i="",(r.attrs.src||"").includes("data:image/svg+xml;utf8,")){t+=r.attrs.src.substr(24).replace(/%23/g,"#").replace("<svg",'<svg style="'+(r.attrs.style||"")+'"');continue}}else if("video"===r.name||"audio"===r.name)if(r=JSON.parse(JSON.stringify(r)),r.src.length>1){r.children=[];for(let t=0;t<r.src.length;t++)r.children.push({name:"source",attrs:{src:r.src[t]}})}else r.attrs.src=r.src[0];else"div"===r.name&&(r.attrs.style||"").includes("overflow:auto")&&"table"===(r.children[0]||{}).name&&(r=r.children[0]);if("table"===r.name&&(r=JSON.parse(JSON.stringify(r)),s=r.attrs,(r.attrs.style||"").includes("display:grid"))){r.attrs.style=r.attrs.style.split("display:grid")[0];const t=[{name:"tr",attrs:{},children:[]}];for(let e=0;e<r.children.length;e++)r.children[e].attrs.style=r.children[e].attrs.style.replace(/grid-[^;]+;*/g,""),r.children[e].r!==t.length?t.push({name:"tr",attrs:{},children:[r.children[e]]}):t[t.length-1].children.push(r.children[e]);r.children=t}t+="<"+r.name;for(const e in r.attrs){let i=r.attrs[e];i&&("T"!==i&&!0!==i?"t"===r.name[0]&&"style"===e&&s&&(i=i.replace(/;*display:table[^;]*/,""),s.border&&(i=i.replace(/border[^;]+;*/g,(t=>t.includes("collapse")?t:""))),s.cellpadding&&(i=i.replace(/padding[^;]+;*/g,"")),!i)||(t+=" "+e+'="'+i.replace(/"/g,"&quot;")+'"'):t+=" "+e)}t+=">",r.children&&(e(r.children,s),t+="</"+r.name+">")}}}(i.nodes);for(let e=i.plugins.length;e--;)i.plugins[e].onGetContent&&(t=i.plugins[e].onGetContent(t)||t);return t}}i.prototype.onUpdate=function(t,e){this.vm.editable&&(this.vm._maskTap(),e.entities.amp="&",this.inserting||(this.vm._edit=void 0,t||setTimeout((()=>{this.vm.$set(this.vm,"nodes",[{name:"p",attrs:{},children:[{type:"text",text:""}]}])}),0)))},i.prototype.onParse=function(t){!this.vm.editable||"td"!==t.name&&"th"!==t.name||this.vm.getText(t.children)||t.children.push({type:"text",text:""})},exports.Editable=i;
